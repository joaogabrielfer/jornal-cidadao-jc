<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vizualizar Charges</title>
  <style>
    .headerUol{background:#262626;top:0;position:fixed;width:100%;text-align:center;font-size:xx-small;height:30px;z-index:100}
    .h1Uol{color:#fff;margin:0;padding-top:5px}
    .headerJc{background:#d9272e;width:100%;height:130px;margin-top:30px;position:relative}
    .logoJc,.nomeJc{color:#fff;text-align:center}
    .headerNav{background:#a7a6a6;height:40px;display:flex;align-items:center;padding:0 15px;margin:0}
    body{padding-top:0;margin:0;min-height:100vh;display:flex;flex-direction:column;font-family: Arial, sans-serif;}
    .mainCharges{flex-grow:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 0}
    .tituloCharge{text-align:center;margin-bottom:20px;font-size:24px;font-weight:500;color:#333}
    .containerCharge{padding:20px;background:#d9272e;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.1);display:flex;flex-direction:column;align-items:center;width:450px}
    .charge{width:400px;height:350px;background:#F0F0F0;border:1px solid #ccc;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;color:#666;text-align:center;margin-bottom:15px;position:relative;overflow:hidden}
    .charge img{max-width:100%;max-height:100%;display:none}
    .status{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.6);color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;display:none}
    .error{background:#c00}
    .footerCharge{width:100%;display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding:0 10px}
    .dataCharge{font-size:14px;color:#000}
    .botoesNavDaCharge{display:flex;gap:10px}
    .botaoNav{background:#F0F0F0;color:#333;border:1px solid #ccc;width:34px;height:34px;border-radius:5px;font-size:18px;font-weight:bold;cursor:pointer;transition:background-color .2s}
    .botaoNav:hover{background:#E0E0E0}

  </style>
</head>
<body>
  <header class="headerUol">
    <h1 class="h1Uol">Barra da Uol</h1>
  </header>
  <header class="headerJc">
    <div>
      <h1 class="logoJc">Logo do Jc</h1>
      <h1 class="nomeJc">Sistema Jornal do Commercio de comunicação</h1>
    </div>
  </header>
  <header class="headerNav">
    <h1>Barra de navegação</h1>
  </header>

  <main class="mainCharges">
    <h2 id="charge-title" class="tituloCharge">Charge</h2>


    <div class="containerCharge">
      <div class="charge">
        <img id="charge-img" alt="Charge do dia" />
        <span id="loading" class="status">Carregando…</span>
        <span id="error" class="status error">Erro ao carregar</span>
      </div>

      <div class="footerCharge">
        <span class="dataCharge" id="charge-date"></span>
        <span class="nomeCharge" id="charge-author"></span>

        <div class="botoesNavDaCharge">
          <button class="botaoNav setaEsquerda" id="btn-prev" title="Anterior" aria-label="Anterior">&lt;</button>
          <button class="botaoNav" id="btn-random" title="Aleatória" aria-label="Aleatória">?</button>
          <button class="botaoNav setaDireita" id="btn-next" title="Próxima" aria-label="Próxima">&gt;</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const imgEl = document.getElementById('charge-img');
      const titleEl = document.getElementById('charge-title');
      const dateEl = document.getElementById('charge-date');
      const authorEl = document.getElementById('charge-author');
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const prevBtn = document.getElementById('btn-prev');
      const nextBtn = document.getElementById('btn-next');
      const randBtn = document.getElementById('btn-random');

      let list = [];      
      let idx = 0;        

      
      const fallback = '/static/images/charges/charge1.png';
      function showFallback() {
        imgEl.src = fallback;
        imgEl.style.display = 'block';
        titleEl.textContent = 'Charge';
        dateEl.textContent = '';
        authorEl.textContent = '';
        loadingEl.style.display = 'none';
        errorEl.style.display = 'none';
      }

      function setLoading(on) {
        loadingEl.style.display = on ? 'inline-block' : 'none';
        errorEl.style.display = 'none';
        prevBtn.disabled = nextBtn.disabled = randBtn.disabled = on;
      }

      const formatDateBR = (ddmmyyhhmmss) => ddmmyyhhmmss || '';

    
      function mapOne(raw) {
        const d = raw?.charge ?? raw ?? {};
        const url = d.url || (d.filename ? `/static/images/charges/${d.filename}` : '');
        return {
          id: d.id ?? null,
          url,
          title: d.title ?? 'Charge',
          author: d.author ?? '',
          date: d.date ?? ''
        };
      }
     
      function mapList(raw) {
        const arr = Array.isArray(raw) ? raw : (raw?.charges ?? []);
        return arr.map(mapOne).filter(x => !!x.url);
      }

      function render(i) {
        if (!list.length) return showFallback();
        const ch = list[i];

        setLoading(true);
        imgEl.style.display = 'none';

        titleEl.textContent = ch.title ? `Charge – ${ch.title}` : 'Charge';
        authorEl.textContent = ch.author ? `Autor: ${ch.author}` : '';
        dateEl.textContent = formatDateBR(ch.date);

        imgEl.src = ch.url;
        imgEl.alt = ch.title || 'Charge';

        imgEl.onload = () => { setLoading(false); imgEl.style.display = 'block'; };
        imgEl.onerror = () => { setLoading(false); errorEl.style.display = 'inline-block'; };
      }

      function next() {
        if (!list.length) return;
        idx = (idx + 1) % list.length;
        render(idx);
      }
      function prev() {
        if (!list.length) return;
        idx = (idx - 1 + list.length) % list.length;
        render(idx);
      }

      async function fetchJSON(url) {
        const u = `${url}${url.includes('?') ? '&' : '?'}_=${Date.now()}`;
        const r = await fetch(u, { headers: { Accept: 'application/json' }, cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      }

      
      async function randomCharge() {
        try {
          setLoading(true);
          const raw = await fetchJSON('/api/charges/random');
          const ch = mapOne(raw);
         
          const found = list.findIndex(c => (c.id != null && c.id === ch.id) || c.url === ch.url);
          if (found === -1) {
            list.push(ch);
            idx = list.length - 1;
          } else {
            idx = found;
          }
          render(idx);
        } catch (e) {
          console.error(e);
          setLoading(false);
          errorEl.style.display = 'inline-block';
        }
      }

      async function loadList() {
        try {
          setLoading(true);
          const raw = await fetchJSON('/api/charges');
          list = mapList(raw);

          
          if (list.every(x => x.id != null)) {
            list.sort((a,b) => a.id - b.id);
          }

          if (!list.length) throw new Error('Lista vazia');
          idx = 0; 
          render(idx);
        } catch (e) {
          console.error('Falha ao carregar lista:', e);
          setLoading(false);
          showFallback();
        }
      }

      
      showFallback();  
      loadList();

      
      prevBtn.addEventListener('click', prev);
      nextBtn.addEventListener('click', next);
      randBtn.addEventListener('click', randomCharge);
    });
  </script>
</body>
</html>